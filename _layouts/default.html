<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ page.title | default: site.title }}</title>
    {% seo %}
  <link rel="stylesheet" href="/assets/custom.css">
  </head>
  <body>
    {% include nav.html %}

    <main class="site-main">
      <div class="container">
        <script>
        // Site theme controller: reads stored preference, falls back to system, and exposes toggle
        ;(function(){
          const root = document.documentElement;
          function getStored(){ return localStorage.getItem('site-theme'); }
          function setTheme(t){ root.setAttribute('data-theme', t); localStorage.setItem('site-theme', t); document.dispatchEvent(new CustomEvent('theme-changed',{detail: t})); updateToggle(t);}    
          function prefersDark(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
          function init(){ const stored = getStored(); let theme = stored || (prefersDark() ? 'dark' : 'light'); if(stored === 'system') theme = (prefersDark() ? 'dark' : 'light'); root.setAttribute('data-theme', stored === 'system' ? 'system' : theme); updateToggle(stored || 'auto'); }
          function updateToggle(state){ const btn = document.getElementById('theme-toggle'); if(!btn) return; // state: 'dark'|'light'|'auto'|'system'
            const sun = document.getElementById('icon-sun'); const moon = document.getElementById('icon-moon');
            if(state === 'dark'){ btn.setAttribute('aria-pressed','true'); if(sun) sun.style.display='none'; if(moon) moon.style.display='inline-block'; btn.title='Dark mode'; }
            else if(state === 'light'){ btn.setAttribute('aria-pressed','false'); if(sun) sun.style.display='inline-block'; if(moon) moon.style.display='none'; btn.title='Light mode'; }
            else { // auto/system
              btn.setAttribute('aria-pressed','false'); if(sun) sun.style.display='inline-block'; if(moon) moon.style.display='none'; btn.title='Match OS'; }
          }
          function toggle(){ // simple toggle between dark and light; preserves 'system' choice if currently explicit
            const stored = getStored(); if(stored === 'system' || stored === null){ // flip current effective theme
              const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'; setTheme(cur === 'dark' ? 'light' : 'dark');
            } else { const cur = stored === 'dark' ? 'dark' : 'light'; setTheme(cur === 'dark' ? 'light' : 'dark'); }
          }
          function setSystem(){ // revert to system preference
            localStorage.setItem('site-theme','system'); document.documentElement.removeAttribute('data-theme'); document.dispatchEvent(new CustomEvent('theme-changed',{detail: (prefersDark() ? 'dark' : 'light')})); updateToggle('auto'); }

          // attach
          document.addEventListener('DOMContentLoaded', function(){
            init();
            const tb = document.getElementById('theme-toggle'); if(tb) tb.addEventListener('click', toggle);

            // Theme menu wiring: reveal on focusin, hide on focusout, close on Esc
            const menu = document.getElementById('theme-menu');
            if(menu){
              menu.addEventListener('focusin', ()=> menu.setAttribute('aria-hidden','false'));
              menu.addEventListener('focusout', ()=> { setTimeout(()=>{ if(!menu.contains(document.activeElement)) menu.setAttribute('aria-hidden','true'); }, 10); });

              // Buttons inside the theme menu
              const btnLight = document.getElementById('theme-light');
              const btnDark = document.getElementById('theme-dark');
              const btnSystem = document.getElementById('theme-system');
              if(btnLight) btnLight.addEventListener('click', function(){ setTheme('light'); menu.setAttribute('aria-hidden','true'); });
              if(btnDark) btnDark.addEventListener('click', function(){ setTheme('dark'); menu.setAttribute('aria-hidden','true'); });
              if(btnSystem) btnSystem.addEventListener('click', function(){ setSystem(); menu.setAttribute('aria-hidden','true'); });
            }

            // Close menu on Escape anywhere
            document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ const m = document.getElementById('theme-menu'); if(m && m.getAttribute('aria-hidden') === 'false') m.setAttribute('aria-hidden','true'); } });
          });

          // When theme changes, notify giscus iframes (global sync)
          document.addEventListener('theme-changed', function(e){
            const theme = e.detail || document.documentElement.getAttribute('data-theme');
            document.querySelectorAll('iframe.giscus-frame, iframe').forEach(function(iframe){
              try{ iframe.contentWindow.postMessage({giscus: {setConfig: {theme: theme}}}, 'https://giscus.app'); }catch(_){}}
            );
          });
        })();
        </script>

    // When theme changes, notify giscus iframes (global sync)
    document.addEventListener('theme-changed', function(e){
      const theme = e.detail || document.documentElement.getAttribute('data-theme');
      document.querySelectorAll('iframe.giscus-frame, iframe').forEach(function(iframe){
        try{ iframe.contentWindow.postMessage({giscus: {setConfig: {theme: theme}}}, 'https://giscus.app'); }catch(_){}
      });
    });
  })();
  </script>
</html>
